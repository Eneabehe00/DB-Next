using DBNext.Shared;

namespace DBNext;

/// <summary>
/// Finestra piccola per l'operatore che mostra il numero corrente del turno
/// </summary>
public class OperatorDisplayForm : Form
{
    private readonly Label _numberLabel;
    private readonly Label _labelText;
    private readonly TableLayoutPanel _mainLayout;
    private readonly System.Windows.Forms.Timer _updateTimer;
    private readonly System.Windows.Forms.Timer _longPressTimer;
    private QueueSettings _settings = new();
    private bool _isDragging = false;
    private bool _canDrag = false;
    private Point _dragStartPoint;
    private Point _mouseDownPoint;

    public OperatorDisplayForm()
    {
        // Setup form - Piccola finestra sempre in primo piano
        this.Text = "DB-Next - Operatore";
        this.FormBorderStyle = FormBorderStyle.None;
        this.StartPosition = FormStartPosition.Manual;
        this.BackColor = Color.Black;
        this.ForeColor = Color.White;
        this.ShowInTaskbar = false;
        this.TopMost = true;

        // Layout principale - orizzontale (scritta + numero sulla stessa riga)
        _mainLayout = new TableLayoutPanel
        {
            Dock = DockStyle.Fill,
            RowCount = 1,
            ColumnCount = 2
        };
        _mainLayout.ColumnStyles.Add(new ColumnStyle(SizeType.AutoSize)); // Scritta
        _mainLayout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 100F)); // Numero

        // Etichetta "TURNO" - a sinistra
        _labelText = new Label
        {
            Text = "TURNO:",
            ForeColor = Color.White,
            BackColor = Color.Black,
            TextAlign = ContentAlignment.MiddleLeft,
            Dock = DockStyle.Fill,
            Font = new Font("Arial Black", 24, FontStyle.Bold),
            Visible = true,
            Padding = new Padding(10, 0, 5, 0)
        };

        // Label per il numero - a destra
        _numberLabel = new Label
        {
            Text = "00",
            ForeColor = Color.White,
            BackColor = Color.Black,
            TextAlign = ContentAlignment.MiddleRight,
            Dock = DockStyle.Fill,
            Font = new Font("Arial Black", 24, FontStyle.Bold),
            Padding = new Padding(5, 0, 10, 0)
        };

        _mainLayout.Controls.Add(_labelText, 0, 0);
        _mainLayout.Controls.Add(_numberLabel, 1, 0);

        this.Controls.Add(_mainLayout);

        // Timer per aggiornare il numero
        _updateTimer = new System.Windows.Forms.Timer { Interval = 1000 };
        _updateTimer.Tick += async (s, e) => await UpdateNumberAsync();

        // Timer per riconoscimento tocco prolungato (800ms)
        _longPressTimer = new System.Windows.Forms.Timer { Interval = 800 };
        _longPressTimer.Tick += LongPressTimer_Tick;

        // Gestione chiusura
        this.KeyDown += (s, e) =>
        {
            if (e.KeyCode == Keys.Escape)
                this.Hide();
        };

        // Gestione trascinamento e tocco prolungato
        this.MouseDown += OperatorDisplayForm_MouseDown;
        this.MouseMove += OperatorDisplayForm_MouseMove;
        this.MouseUp += OperatorDisplayForm_MouseUp;

        // Click destro per nascondere
        this.MouseClick += (s, e) =>
        {
            if (e.Button == MouseButtons.Right)
                this.Hide();
        };

        this.Load += OperatorDisplayForm_Load;
        this.FormClosing += (s, e) =>
        {
            e.Cancel = true; // Non chiudere, solo nascondere
            this.Hide();
        };
    }

    private void OperatorDisplayForm_Load(object? sender, EventArgs e)
    {
        LoadSettings();
        _updateTimer.Start();
    }

    private void LoadSettings()
    {
        try
        {
            // Carica impostazioni dal database
            var task = Task.Run(async () => await Database.GetSettingsAsync());
            _settings = task.Result;

            // Posiziona sul monitor selezionato
            var targetScreen = GetTargetScreen();
            var bounds = targetScreen.Bounds;

            // Applica impostazioni
            var x = Math.Min(bounds.Right - _settings.OperatorWindowWidth, Math.Max(bounds.Left, _settings.OperatorWindowX));
            var y = Math.Min(bounds.Bottom - _settings.OperatorWindowHeight, Math.Max(bounds.Top, _settings.OperatorWindowY));
            this.Location = new Point(x, y);
            this.Size = new Size(_settings.OperatorWindowWidth, _settings.OperatorWindowHeight);
            this.BackColor = ColorFromHex(_settings.OperatorBgColor);
            _numberLabel.BackColor = this.BackColor;
            _numberLabel.ForeColor = ColorFromHex(_settings.OperatorTextColor);
            _labelText.BackColor = this.BackColor;
            _labelText.ForeColor = ColorFromHex(_settings.OperatorTextColor);
            this.TopMost = _settings.OperatorAlwaysOnTop;

            // Etichetta (sempre visibile sulla stessa riga)
            _labelText.Text = (_settings.OperatorLabelText ?? "TURNO").TrimEnd(':') + ":";

            // Font unificato per scritta e numero
            try
            {
                var font = new Font(
                    _settings.OperatorFontFamily,
                    _settings.OperatorFontSize,
                    FontStyle.Bold
                );
                _labelText.Font = font;
                _numberLabel.Font = font;
            }
            catch
            {
                var font = new Font("Arial Black", _settings.OperatorFontSize, FontStyle.Bold);
                _labelText.Font = font;
                _numberLabel.Font = font;
            }
        }
        catch (Exception ex)
        {
            Logger.Error($"Errore caricamento impostazioni operatore: {ex.Message}");
        }
    }

    private async Task UpdateNumberAsync()
    {
        try
        {
            var state = await Database.GetStateAsync();
            _numberLabel.Text = state.CurrentNumber.ToString("00");
        }
        catch (Exception ex)
        {
            Logger.Error($"Errore aggiornamento numero operatore: {ex.Message}");
            _numberLabel.Text = "--";
        }
    }

    /// <summary>
    /// Aggiorna le impostazioni e la posizione della finestra
    /// </summary>
    public void UpdateSettings(QueueSettings settings)
    {
        _settings = settings;
        LoadSettings();
    }

    private void OperatorDisplayForm_MouseDown(object? sender, MouseEventArgs e)
    {
        if (e.Button == MouseButtons.Left)
        {
            _mouseDownPoint = new Point(e.X, e.Y);
            _canDrag = false;

            // Avvia timer per tocco prolungato
            _longPressTimer.Start();
        }
    }

    private void OperatorDisplayForm_MouseMove(object? sender, MouseEventArgs e)
    {
        if (_isDragging && _canDrag)
        {
            Point newPoint = this.PointToScreen(new Point(e.X, e.Y));
            newPoint.Offset(-_dragStartPoint.X, -_dragStartPoint.Y);
            this.Location = newPoint;
        }
        else if (_longPressTimer.Enabled)
        {
            // Se ci si muove troppo durante il timer, annulla il tocco prolungato
            var distance = Math.Sqrt(Math.Pow(e.X - _mouseDownPoint.X, 2) + Math.Pow(e.Y - _mouseDownPoint.Y, 2));
            if (distance > 10) // 10 pixel di tolleranza
            {
                _longPressTimer.Stop();
            }
        }
    }

    private void OperatorDisplayForm_MouseUp(object? sender, MouseEventArgs e)
    {
        _longPressTimer.Stop();

        if (_isDragging && _canDrag)
        {
            // Salva la nuova posizione quando finisce il trascinamento
            _settings.OperatorWindowX = this.Location.X;
            _settings.OperatorWindowY = this.Location.Y;

            // Salva nel database in background
            Task.Run(async () =>
            {
                try
                {
                    await Database.SaveSettingsAsync(_settings);
                }
                catch (Exception ex)
                {
                    Logger.Error($"Errore salvataggio posizione finestra operatore: {ex.Message}");
                }
            });
        }

        _isDragging = false;
        _canDrag = false;
    }

    private void LongPressTimer_Tick(object? sender, EventArgs e)
    {
        _longPressTimer.Stop();
        _canDrag = true;
        _isDragging = true;
        _dragStartPoint = _mouseDownPoint;

        // Feedback visivo (cambio colore temporaneo)
        this.BackColor = Color.FromArgb(100, 100, 150); // Blu scuro per indicare modalitÃ  drag
        _labelText.BackColor = this.BackColor;
        _numberLabel.BackColor = this.BackColor;

        // Ripristina colore dopo un breve delay
        Task.Delay(200).ContinueWith(_ =>
        {
            this.Invoke(() =>
            {
                LoadSettings(); // Riapplica i colori originali
            });
        });
    }

    private Screen GetTargetScreen()
    {
        var screens = Screen.AllScreens;
        var targetIndex = Math.Min(_settings.OperatorMonitorIndex, screens.Length - 1);
        targetIndex = Math.Max(0, targetIndex);
        return screens[targetIndex];
    }

    private static Color ColorFromHex(string hex)
    {
        try
        {
            hex = hex.TrimStart('#');
            if (hex.Length == 6)
            {
                return Color.FromArgb(
                    Convert.ToInt32(hex.Substring(0, 2), 16),
                    Convert.ToInt32(hex.Substring(2, 2), 16),
                    Convert.ToInt32(hex.Substring(4, 2), 16));
            }
        }
        catch { }

        return hex == "#000000" ? Color.Black : Color.White;
    }
}
